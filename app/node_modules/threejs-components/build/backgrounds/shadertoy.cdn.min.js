import{Clock as e,PerspectiveCamera as i,Scene as t,WebGLRenderer as s,SRGBColorSpace as n,MathUtils as o,Mesh as r,Vector4 as a,Vector2 as h,PlaneGeometry as c,ShaderMaterial as d,OrthographicCamera as m}from"https://cdn.jsdelivr.net/npm/three@0.181.0/+esm";class p{#e;canvas;camera;cameraMinAspect;cameraMaxAspect;cameraFov;maxPixelRatio;minPixelRatio;scene;renderer;#i;size={width:0,height:0,wWidth:0,wHeight:0,ratio:0,pixelRatio:0};render=this.#t;onBeforeRender=()=>{};onAfterRender=()=>{};onAfterResize=()=>{};#s=!1;#n=!1;isDisposed=!1;#o;#r;#a;#h=new e;#c={elapsed:0,delta:0};#d;#m;#p=0;#l=0;constructor(e){this.#e={...e},this.#u(),this.#v(),this.#f(),this.resize(),this.#g()}#u(){this.camera=new i,this.cameraFov=this.camera.fov}#v(){this.scene=new t}#f(){this.#e.canvas?this.canvas=this.#e.canvas:this.#e.id?this.canvas=document.getElementById(this.#e.id):console.error("Three: Missing canvas or id parameter"),this.canvas.style.display="block",this.canvas.style.touchAction="none";const e={canvas:this.canvas,powerPreference:"high-performance",...this.#e.rendererOptions??{}};this.renderer=new s(e),this.renderer.outputColorSpace=n}#g(){this.#e.size instanceof Object||(window.addEventListener("resize",this.#z.bind(this)),"parent"===this.#e.size&&(this.#r=new ResizeObserver(this.#z.bind(this)),this.#r.observe(this.canvas.parentNode))),this.#o=new IntersectionObserver(this.#w.bind(this),{root:null,rootMargin:"0px",threshold:0}),this.#o.observe(this.canvas),document.addEventListener("visibilitychange",this.#R.bind(this))}#b(){window.removeEventListener("resize",this.#z.bind(this)),this.#r?.disconnect(),this.#o?.disconnect(),document.removeEventListener("visibilitychange",this.#R.bind(this))}#w(e){this.#s=e[0].isIntersecting,this.#s?this.#x():this.#y()}#R(e){this.#s&&(document.hidden?this.#y():this.#x())}#z(){this.#a&&clearTimeout(this.#a),this.#a=setTimeout(this.resize.bind(this),100)}resize(){let e,i;this.#e.size instanceof Object?(e=this.#e.size.width,i=this.#e.size.height):"parent"===this.#e.size&&this.canvas.parentNode?(e=this.canvas.parentNode.offsetWidth,i=this.canvas.parentNode.offsetHeight):(e=window.innerWidth,i=window.innerHeight),this.size.width=e,this.size.height=i,this.size.ratio=e/i,this.#M(),this.#L(),this.onAfterResize(this.size)}#M(){this.camera.aspect=this.size.width/this.size.height,this.camera.isPerspectiveCamera&&this.cameraFov&&(this.cameraMinAspect&&this.camera.aspect<this.cameraMinAspect?this.#T(this.cameraMinAspect):this.cameraMaxAspect&&this.camera.aspect>this.cameraMaxAspect?this.#T(this.cameraMaxAspect):this.camera.fov=this.cameraFov),this.camera.updateProjectionMatrix(),this.updateWorldSize()}#T(e){const i=Math.tan(o.degToRad(this.cameraFov/2))/(this.camera.aspect/e);this.camera.fov=2*o.radToDeg(Math.atan(i))}updateWorldSize(){if(this.camera.isPerspectiveCamera){const e=this.camera.fov*Math.PI/180;this.size.wHeight=2*Math.tan(e/2)*this.camera.position.length(),this.size.wWidth=this.size.wHeight*this.camera.aspect}else this.camera.isOrthographicCamera&&(this.size.wHeight=this.camera.top-this.camera.bottom,this.size.wWidth=this.camera.right-this.camera.left)}#L(){this.renderer.setSize(this.size.width,this.size.height),this.#i?.setSize(this.size.width,this.size.height);let e=window.devicePixelRatio;this.maxPixelRatio&&e>this.maxPixelRatio?e=this.maxPixelRatio:this.minPixelRatio&&e<this.minPixelRatio&&(e=this.minPixelRatio),this.renderer.setPixelRatio(e),this.size.pixelRatio=e}get postprocessing(){return this.#i}set postprocessing(e){this.#i=e,this.render=e.render.bind(e)}get fpsLimit(){return this.#m}set fpsLimit(e){this.#m=e,this.#p=e>0?1/e:0}#x(){if(this.#n)return;console.log("Start rendering");const e=()=>{this.#d=requestAnimationFrame(e),this.#c.elapsed=this.#h.getElapsedTime();const i=this.#c.elapsed-this.#l;(!this.#m||this.#m&&i>this.#p)&&(this.#c.delta=i,this.onBeforeRender(this.#c),this.render(),this.onAfterRender(this.#c),this.#l=this.#c.elapsed)};this.#n=!0,this.#h.start(),e()}#y(){this.#n&&(console.log("Stop rendering"),cancelAnimationFrame(this.#d),this.#n=!1,this.#h.stop(),this.#l=0)}#t(){this.renderer.render(this.scene,this.camera)}clear(){this.scene.traverse(e=>{e.isMesh&&"object"==typeof e.material&&(Object.keys(e.material).forEach(i=>{const t=e.material[i];null!==t&&"object"==typeof t&&"function"==typeof t.dispose&&t.dispose()}),e.material.dispose(),e.geometry.dispose())}),this.scene.clear()}dispose(){console.log("dispose"),this.#b(),this.#y(),this.clear(),this.#i?.dispose(),this.renderer.dispose(),this.isDisposed=!0}}class l extends r{speed=1;constructor(){const e={iResolution:{value:new h},iTime:{value:0},iTimeDelta:{value:0},iMouse:{value:new a}};super(new c(2,2),new d({uniforms:e})),this.uniforms=e}get fragmentShader(){return this.material.fragmentShader}set fragmentShader(e){if(!e)return;const i=`\n      uniform vec2 iResolution;\n      uniform float iTime;\n      uniform float iTimeDelta;\n      uniform vec4 iMouse;\n\n      ${e}\n\n      void main() {\n        mainImage(gl_FragColor, gl_FragCoord.xy);\n      }\n    `;this.material.fragmentShader=i,this.material.needsUpdate=!0}update(e){this.uniforms.iTime.value+=e.delta*this.speed,this.uniforms.iTimeDelta.value=e.delta*this.speed}setSize({width:e,height:i,pixelRatio:t}){this.uniforms.iResolution.value.set(e*t,i*t)}dispose(){this.material.dispose(),this.geometry.dispose()}}const u=new Map,v=new h;let f=!1;function g(e){const i={position:new h,nPosition:new h,hover:!1,pressed:!1,onEnter(){},onLeave(){},onMove(){},onDown(){},onUp(){},onClick(){},...e};return function(e,i){u.has(e)||(u.set(e,i),f||(document.body.addEventListener("pointermove",w),document.body.addEventListener("pointerleave",R),document.body.addEventListener("pointerdown",b),document.body.addEventListener("pointerup",x),document.body.addEventListener("click",y),f=!0))}(e.domElement,i),i.dispose=()=>{var i;i=e.domElement,u.delete(i),0===u.size&&(document.body.removeEventListener("pointermove",w),document.body.removeEventListener("pointerleave",R),document.body.removeEventListener("pointerdown",b),document.body.removeEventListener("pointerup",x),document.body.removeEventListener("click",y),f=!1)},i}function z(e,i){v.x=e.clientX,v.y=e.clientY;for(const[e,t]of u){i(t,e.getBoundingClientRect())}}function w(e){z(e,(i,t)=>{L(t)?(M(i,t),i.hover||(i.hover=!0,i.onEnter(i)),i.pressed=e.buttons>0,i.onMove(i)):i.hover&&(i.hover=!1,i.pressed=!1,i.onLeave(i))})}function R(){for(const e of u.values())e.hover&&(e.hover=!1,e.onLeave(e))}function b(e){z(e,(e,i)=>{L(i)&&(M(e,i),e.onDown(e))})}function x(e){z(e,(e,i)=>{L(i)&&(M(e,i),e.onUp(e))})}function y(e){z(e,(e,i)=>{L(i)&&(M(e,i),e.onClick(e))})}function M(e,i){const{position:t,nPosition:s}=e;t.x=v.x-i.left,t.y=v.y-i.top,s.x=t.x/i.width*2-1,s.y=-t.y/i.height*2+1}function L(e){const{x:i,y:t}=v,{left:s,top:n,width:o,height:r}=e;return i>=s&&i<=s+o&&t>=n&&t<=n+r}function T(e,{fragmentShader:i}={}){const t=new p({canvas:e,size:"parent"});t.camera=new m,t.camera.position.z=1;const s=new l;i&&(s.fragmentShader=i),t.scene.add(s);const n=g({domElement:e,onDown(){const e=n.position.x*t.size.pixelRatio,i=(t.size.height-n.position.y)*t.size.pixelRatio;s.uniforms.iMouse.value.x=e,s.uniforms.iMouse.value.y=i,s.uniforms.iMouse.value.z=e,s.uniforms.iMouse.value.w=i},onUp(){const e=s.uniforms.iMouse.value.z;s.uniforms.iMouse.value.z=e>0?-e:e},onMove(){const e=n.position.x*t.size.pixelRatio,i=(t.size.height-n.position.y)*t.size.pixelRatio;if(n.pressed){s.uniforms.iMouse.value.x=e,s.uniforms.iMouse.value.y=i;const t=s.uniforms.iMouse.value.z;s.uniforms.iMouse.value.z=t<0?-t:t}}});return t.onBeforeRender=e=>{s.update(e)},t.onAfterRender=()=>{const e=s.uniforms.iMouse.value.w;s.uniforms.iMouse.value.w=e>0?-e:e},t.onAfterResize=e=>{s.setSize(e)},{three:t,shaderPlane:s,dispose(){n.dispose(),t.dispose()}}}export{T as default};
