import{Clock as e,PerspectiveCamera as t,Scene as i,WebGLRenderer as s,SRGBColorSpace as r,MathUtils as n,Vector2 as a,TextureLoader as o,WebGLRenderTarget as h,RGBAFormat as d,FloatType as c,LinearFilter as l,ShaderMaterial as m,Uniform as p,Mesh as u,PlaneGeometry as f,MeshStandardMaterial as v,PMREMGenerator as g,EquirectangularReflectionMapping as x}from"https://cdn.jsdelivr.net/npm/three@0.181.0/+esm";import"https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/loaders/GLTFLoader.js/+esm";import"https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/loaders/DRACOLoader.js/+esm";import{HDRLoader as w}from"https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/loaders/HDRLoader.js/+esm";import{RoomEnvironment as z}from"https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/environments/RoomEnvironment.js/+esm";import{FullScreenQuad as S}from"https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/postprocessing/Pass.js/+esm";class D{#e;canvas;camera;cameraMinAspect;cameraMaxAspect;cameraFov;maxPixelRatio;minPixelRatio;scene;renderer;#t;size={width:0,height:0,wWidth:0,wHeight:0,ratio:0,pixelRatio:0};render=this.#i;onBeforeRender=()=>{};onAfterRender=()=>{};onAfterResize=()=>{};#s=!1;#r=!1;isDisposed=!1;#n;#a;#o;#h=new e;#d={elapsed:0,delta:0};#c;#l;#m=0;#p=0;constructor(e){this.#e={...e},this.#u(),this.#f(),this.#v(),this.resize(),this.#g()}#u(){this.camera=new t,this.cameraFov=this.camera.fov}#f(){this.scene=new i}#v(){this.#e.canvas?this.canvas=this.#e.canvas:this.#e.id?this.canvas=document.getElementById(this.#e.id):console.error("Three: Missing canvas or id parameter"),this.canvas.style.display="block",this.canvas.style.touchAction="none";const e={canvas:this.canvas,powerPreference:"high-performance",...this.#e.rendererOptions??{}};this.renderer=new s(e),this.renderer.outputColorSpace=r}#g(){this.#e.size instanceof Object||(window.addEventListener("resize",this.#x.bind(this)),"parent"===this.#e.size&&(this.#a=new ResizeObserver(this.#x.bind(this)),this.#a.observe(this.canvas.parentNode))),this.#n=new IntersectionObserver(this.#w.bind(this),{root:null,rootMargin:"0px",threshold:0}),this.#n.observe(this.canvas),document.addEventListener("visibilitychange",this.#z.bind(this))}#S(){window.removeEventListener("resize",this.#x.bind(this)),this.#a?.disconnect(),this.#n?.disconnect(),document.removeEventListener("visibilitychange",this.#z.bind(this))}#w(e){this.#s=e[0].isIntersecting,this.#s?this.#D():this.#R()}#z(e){this.#s&&(document.hidden?this.#R():this.#D())}#x(){this.#o&&clearTimeout(this.#o),this.#o=setTimeout(this.resize.bind(this),100)}resize(){let e,t;this.#e.size instanceof Object?(e=this.#e.size.width,t=this.#e.size.height):"parent"===this.#e.size&&this.canvas.parentNode?(e=this.canvas.parentNode.offsetWidth,t=this.canvas.parentNode.offsetHeight):(e=window.innerWidth,t=window.innerHeight),this.size.width=e,this.size.height=t,this.size.ratio=e/t,this.#M(),this.#y(),this.onAfterResize(this.size)}#M(){this.camera.aspect=this.size.width/this.size.height,this.camera.isPerspectiveCamera&&this.cameraFov&&(this.cameraMinAspect&&this.camera.aspect<this.cameraMinAspect?this.#b(this.cameraMinAspect):this.cameraMaxAspect&&this.camera.aspect>this.cameraMaxAspect?this.#b(this.cameraMaxAspect):this.camera.fov=this.cameraFov),this.camera.updateProjectionMatrix(),this.updateWorldSize()}#b(e){const t=Math.tan(n.degToRad(this.cameraFov/2))/(this.camera.aspect/e);this.camera.fov=2*n.radToDeg(Math.atan(t))}updateWorldSize(){if(this.camera.isPerspectiveCamera){const e=this.camera.fov*Math.PI/180;this.size.wHeight=2*Math.tan(e/2)*this.camera.position.length(),this.size.wWidth=this.size.wHeight*this.camera.aspect}else this.camera.isOrthographicCamera&&(this.size.wHeight=this.camera.top-this.camera.bottom,this.size.wWidth=this.camera.right-this.camera.left)}#y(){this.renderer.setSize(this.size.width,this.size.height),this.#t?.setSize(this.size.width,this.size.height);let e=window.devicePixelRatio;this.maxPixelRatio&&e>this.maxPixelRatio?e=this.maxPixelRatio:this.minPixelRatio&&e<this.minPixelRatio&&(e=this.minPixelRatio),this.renderer.setPixelRatio(e),this.size.pixelRatio=e}get postprocessing(){return this.#t}set postprocessing(e){this.#t=e,this.render=e.render.bind(e)}get fpsLimit(){return this.#l}set fpsLimit(e){this.#l=e,this.#m=e>0?1/e:0}#D(){if(this.#r)return;console.log("Start rendering");const e=()=>{this.#c=requestAnimationFrame(e),this.#d.elapsed=this.#h.getElapsedTime();const t=this.#d.elapsed-this.#p;(!this.#l||this.#l&&t>this.#m)&&(this.#d.delta=t,this.onBeforeRender(this.#d),this.render(),this.onAfterRender(this.#d),this.#p=this.#d.elapsed)};this.#r=!0,this.#h.start(),e()}#R(){this.#r&&(console.log("Stop rendering"),cancelAnimationFrame(this.#c),this.#r=!1,this.#h.stop(),this.#p=0)}#i(){this.renderer.render(this.scene,this.camera)}clear(){this.scene.traverse(e=>{e.isMesh&&"object"==typeof e.material&&(Object.keys(e.material).forEach(t=>{const i=e.material[t];null!==i&&"object"==typeof i&&"function"==typeof i.dispose&&i.dispose()}),e.material.dispose(),e.geometry.dispose())}),this.scene.clear()}dispose(){console.log("dispose"),this.#S(),this.#R(),this.clear(),this.#t?.dispose(),this.renderer.dispose(),this.isDisposed=!0}}const R=new Map,M=new a;let y,b,E=!1;function U(e){const t={position:new a,nPosition:new a,hover:!1,pressed:!1,onEnter(){},onLeave(){},onMove(){},onDown(){},onUp(){},onClick(){},...e};return function(e,t){R.has(e)||(R.set(e,t),E||(document.body.addEventListener("pointermove",C),document.body.addEventListener("pointerleave",P),document.body.addEventListener("pointerdown",F),document.body.addEventListener("pointerup",A),document.body.addEventListener("click",T),E=!0))}(e.domElement,t),t.dispose=()=>{var t;t=e.domElement,R.delete(t),0===R.size&&(document.body.removeEventListener("pointermove",C),document.body.removeEventListener("pointerleave",P),document.body.removeEventListener("pointerdown",F),document.body.removeEventListener("pointerup",A),document.body.removeEventListener("click",T),E=!1)},t}function L(e,t){M.x=e.clientX,M.y=e.clientY;for(const[e,i]of R){t(i,e.getBoundingClientRect())}}function C(e){L(e,(t,i)=>{O(i)?(j(t,i),t.hover||(t.hover=!0,t.onEnter(t)),t.pressed=e.buttons>0,t.onMove(t)):t.hover&&(t.hover=!1,t.pressed=!1,t.onLeave(t))})}function P(){for(const e of R.values())e.hover&&(e.hover=!1,e.onLeave(e))}function F(e){L(e,(e,t)=>{O(t)&&(j(e,t),e.onDown(e))})}function A(e){L(e,(e,t)=>{O(t)&&(j(e,t),e.onUp(e))})}function T(e){L(e,(e,t)=>{O(t)&&(j(e,t),e.onClick(e))})}function j(e,t){const{position:i,nPosition:s}=e;i.x=M.x-t.left,i.y=M.y-t.top,s.x=i.x/t.width*2-1,s.y=-i.y/t.height*2+1}function O(e){const{x:t,y:i}=M,{left:s,top:r,width:n,height:a}=e;return t>=s&&t<=s+n&&i>=r&&i<=r+a}async function I(e,t){let i;return i=e.endsWith(".hdr")?await function(e,t){b||(b=new w);return b.loadAsync(e,t)}(e,t):await function(e,t){y||(y=new o);return y.loadAsync(e,t)}(e,t),i}var k="varying vec2 vUv;void main(){vUv=uv;gl_Position=vec4(position,1.0);}";const q=512;class B{#E;#U;#L;attenuation;#C;#P;#F;#A;#T;#j;#O;#I=[];constructor({renderer:e}){this.#E=e,this.#U={value:1},this.#L={value:new a(1/q,1/q)},this.attenuation={value:.995},this.#k(),this.#q()}#k(){const e={minFilter:l,magFilter:l,type:c,format:d,depthBuffer:!1,stencilBuffer:!1};this.#C=new h(q,q,e),this.#P=new h(q,q,e),this.#F=new S}#q(){this.#A=new m({uniforms:{tDiffuse:{value:null}},vertexShader:k,fragmentShader:"uniform sampler2D tDiffuse;varying vec2 vUv;void main(){gl_FragColor=texture2D(tDiffuse,vUv);}"}),this.#T=new m({uniforms:{tDiffuse:{value:null},texelSize:this.#L,attenuation:this.attenuation},vertexShader:k,fragmentShader:"uniform sampler2D tDiffuse;uniform vec2 texelSize;uniform float attenuation;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);vec2 dx=vec2(texelSize.x,0.0);vec2 dy=vec2(0.0,texelSize.y);float average=(texture2D(tDiffuse,vUv-dx).r+texture2D(tDiffuse,vUv-dy).r+texture2D(tDiffuse,vUv+dx).r+texture2D(tDiffuse,vUv+dy).r)*0.25;texel.g+=(average-texel.r)*2.0;texel.g*=attenuation;texel.r+=texel.g;gl_FragColor=texel;}"}),this.#j=new m({uniforms:{tDiffuse:{value:null},texelSize:this.#L},vertexShader:k,fragmentShader:"uniform sampler2D tDiffuse;uniform vec2 texelSize;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);vec3 dx=vec3(texelSize.x,0.0,texture2D(tDiffuse,vec2(vUv.x+texelSize.x,vUv.y)).r-texel.r);vec3 dy=vec3(0.0,texelSize.y,texture2D(tDiffuse,vec2(vUv.x,vUv.y+texelSize.y)).r-texel.r);texel.ba=normalize(cross(dx,dy)).xy;gl_FragColor=texel;}"}),this.#O=new m({uniforms:{tDiffuse:{value:null},aspectRatio:this.#U,center:new p(new a),radius:{value:.05},strength:{value:.5}},vertexShader:k,fragmentShader:"const float PI=3.1415926535897932384626433832795;uniform sampler2D tDiffuse;uniform float aspectRatio;uniform vec2 center;uniform float radius;uniform float strength;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);vec2 p=center*0.5+0.5-vUv;p.x*=aspectRatio;float drop=max(0.0,1.0-length(p)/radius);drop=0.5-cos(drop*PI)*0.5;texel.r+=drop*strength;gl_FragColor=texel;}"})}get texture(){return this.#C.texture}setSize({width:e,height:t,ratio:i}){let s=e,r=t;e>t?(s=q,r=Math.floor(t*(q/e))):(r=q,s=Math.floor(e*(q/t))),this.#U.value=i,this.#L.value.set(1/s,1/r),this.#C.setSize(s,r),this.#P.setSize(s,r)}update(){const e=this.#E.getRenderTarget();this.#B(),this.#N(),this.#W(),this.#E.setRenderTarget(e)}#N(){this.#T.uniforms.tDiffuse.value=this.#C.texture,this.#_(this.#T,this.#P),this.#H()}#W(){this.#j.uniforms.tDiffuse.value=this.#C.texture,this.#_(this.#j,this.#P),this.#H()}addDrop(e,t,i,s){this.#I.push({x:e,y:t,radius:i,strength:s})}#B(){for(let e=0;e<this.#I.length;e++){const t=this.#I[e];this.#V(t.x,t.y,t.radius,t.strength)}this.#I.splice(0)}#V(e,t,i,s){this.#O.uniforms.tDiffuse.value=this.#C.texture,this.#O.uniforms.center.value.set(e,t),this.#O.uniforms.radius.value=this.#U.value>1?i*this.#U.value:i,this.#O.uniforms.strength.value=s,this.#_(this.#O,this.#P),this.#H()}#_(e,t){this.#F.material=e,this.#E.setRenderTarget(t),this.#F.render(this.#E)}#H(){const e=this.#C;this.#C=this.#P,this.#P=e}dispose(){this.#A.dispose(),this.#T.dispose(),this.#j.dispose(),this.#O.dispose(),this.#C.dispose(),this.#P.dispose()}}class N extends u{#Q;#G=1;constructor({renderer:e}){super(new f(1,1,1,1),new v({metalness:.75,roughness:.5})),this.rotation.x=-Math.PI/2,this.#Q=new B({renderer:e}),this.uniforms={uvMapScale:{value:new a(1,1)},displacementMap:{value:this.#Q.texture},displacementScale:{value:1}},this.material.defines={USE_UV:""},this.material.onBeforeCompile=e=>{Object.assign(e.uniforms,this.uniforms),e.fragmentShader="\n        uniform vec2 uvMapScale;\n        uniform sampler2D displacementMap;\n        uniform float displacementScale;\n\n        float redOffset   = 0.01;\n        float greenOffset = 0.02;\n        float blueOffset  = 0.03;\n      "+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>","\n        vec4 disp = texture2D(displacementMap, vUv);\n        vec3 transformedNormal = vec3(disp.b, disp.a, sqrt(1.0 - dot(disp.ba, disp.ba)));\n        #ifdef USE_MAP\n          // vec2 newUv = ((vUv - 0.5) * uvMapScale + 0.5) + transformedNormal.xy * transformedNormal.z * displacementScale * 0.02;\n          vec2 dUv = transformedNormal.xy * displacementScale * 0.02;\n          vec2 newUv = ((vUv - 0.5) * uvMapScale + 0.5) + dUv;\n          float st = smoothstep(0.0, 0.1, length(dUv));\n          diffuseColor.r *= texture2D(map, newUv + redOffset * st).r;\n          diffuseColor.g *= texture2D(map, newUv + greenOffset * st).g;\n          diffuseColor.b *= texture2D(map, newUv + blueOffset * st).b;\n          // vec4 sampledDiffuseColor = texture2D(map, newUv);\n          // diffuseColor *= sampledDiffuseColor;\n        #endif\n      "),e.fragmentShader=e.fragmentShader.replace("#include <normal_fragment_maps>","\n        normal = transformedNormal;\n      ")};const t=new g(e).fromScene(new z,.04).texture;this.material.envMap=t}get attenuation(){return this.#Q.attenuation.value}set attenuation(e){this.#Q.attenuation.value=e}update(){this.#Q.update()}addDrop(e,t,i,s){this.#Q.addDrop(e,t,i,s)}setImage(e){this.material.map=e,this.material.needsUpdate=!0,this.#X()}#X(){const e=this.material.map;if(e&&e.image){const t=e.image.width/e.image.height;this.#G<t?this.uniforms.uvMapScale.value.set(this.#G/t,1):this.uniforms.uvMapScale.value.set(1,t/this.#G)}else this.uniforms.uvMapScale.value.set(1,1)}setEnvMap(e){this.material.envMap=e,this.material.needsUpdate=!0}setSize(e){this.#G=e.ratio,this.scale.set(e.wWidth,e.wHeight,1),this.#X(),this.#Q.setSize(e)}dispose(){this.#Q.dispose()}}const{randFloatSpread:W,randFloat:_}=n;function H(e,t={}){const i=new D({canvas:e,size:"parent"});i.camera.position.y=10,i.camera.lookAt(0,0,0),i.updateWorldSize();const s=new N({renderer:i.renderer});s.setSize(i.size),i.scene.add(s);const n={enable:!0,time:0,timeDelta:.05},a=U({domElement:e});return a.onMove=()=>{s.addDrop(a.nPosition.x,a.nPosition.y,.025,.0025)},a.onClick=()=>{s.addDrop(a.nPosition.x,a.nPosition.y,.025,.05)},i.onBeforeRender=e=>{n.enable&&(n.time+=e.delta,n.time>n.timeDelta&&(s.addDrop(W(2),W(2),_(.01,.02),_(.001,.005)),n.time=0)),s.update()},i.onAfterResize=e=>{s.setSize(e)},{three:i,liquidPlane:s,async loadImage(e){if(e){const t=await I(e);t.colorSpace=r,s.setImage(t)}else s.setImage(null)},async loadEnvMap(e){if(e){const t=await I(e);t.colorSpace=r,t.mapping=x,s.setEnvMap(t)}else s.setEnvMap(null)},setRain(e){n.enable=e},setRainTime(e){n.timeDelta=e},dispose:()=>{a.dispose(),s.dispose(),i.dispose()}}}export{H as default};
